<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@remix-run/router@1.13.1/dist/router.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-router@6.20.1/dist/umd/react-router.production.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/react-router-dom@6.20.1/dist/umd/react-router-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>
    <div id="root"></div>


    <script type="text/babel">

        const { createContext } = React;

        const BarcodeContext = createContext();


        const BarcodeProvider = ({ children }) => {
            const [scans, setScans] = useState([]);
            const [isCopied, setIsCopied] = useState(false);
            const [isSharing, setIsSharing] = useState(false);

            const copyTextToClipboard = async (text) => {
                if ('clipboard' in navigator) {
                    return await navigator.clipboard.writeText(text);
                } else {
                    return document.execCommand('copy', true, text);
                }
            };

            const handleCopyText = (path) => {
                const url = `https://collection.sciencemuseumgroup.org.uk${path}`;

                copyTextToClipboard(url)
                    .then(() => {
                        setIsCopied(true);
                        setTimeout(() => {
                            setIsCopied(false);
                        }, 3000);
                    })
                    .catch((e) =>
                        console.error('There was an error copying text to clipboard', e)
                    );
            };

            const handleShareCard = async (data) => {
                setIsSharing(true);
                try {
                    if (navigator.share) {
                        await navigator.share(data);
                    } else {
                        console.log('Web Share API not supported');
                    }
                } catch (err) {
                    console.error("Couldn't share the record", err);
                } finally {
                    setIsSharing(false);
                }
            };

            const values = {
                scans,
                setScans,
                isCopied,
                setIsCopied,
                isSharing,
                setIsSharing,
                copyTextToClipboard,
                handleCopyText,
                handleShareCard,
            };

            return (
                <BarcodeContext.Provider value={values}>
                    {children}
                </BarcodeContext.Provider>
            );
        };
        window.BarcodeContext = BarcodeContext;
    </script>
    <script type="text/babel">
        const ReactDOM = window.ReactDOM;
        const { useState, useEffect, useCallback, useContext } = React;
        const Html5QrcodeScanner = window.Html5QrcodeScanner;
        const Route = ReactRouterDOM.Route;
        const Routes = ReactRouterDOM.Routes;
        const BrowserRouter = ReactRouterDOM.BrowserRouter;
        const useNavigate = ReactRouterDOM.useNavigate;
        const useLocation = ReactRouterDOM.useLocation;
        const Link = ReactRouterDOM.Link;



        const ScanCard = ({ scans,
            setScans,
            isCopied,
            setIsCopied,
            isSharing,
            setIsSharing,
            copyTextToClipboard,
            handleCopyText,
            handleShareCard, backBtn = true,
            type = 'list',
            title,
            path,
            image, uid
        }) => {

            const navigate = useNavigate();
            const renderActions = () => (
                <>
                    <button onClick={() => handleCopyText(path)}>{isCopied ? 'Copied' : 'Copy'}</button>
                    <button onClick={() => handleShareCard({ title })}>Share</button>
                    <button>
                        <a href={path} target="_blank" rel="noopener noreferrer">Visit URL</a>
                    </button>
                </>
            );

            const renderBackButton = () => (
                <button onClick={() => navigate(-1)}>Back</button>
            );

            return (
                <>
                    {backBtn && renderBackButton()}
                    <article className={`scan-${type}`}>
                        <img src={image} alt={`item ${uid}`} />
                        <h3>{title}</h3>
                        <p>{uid}</p>
                        {renderActions()}
                    </article>
                </>
            );
        };

        const Home = ({ scans,
            updateScans
        }) => {
            const {
                handleShareCard, handleCopyText, isCopied, isSharing,

            } = useContext(BarcodeContext);
            const scansSlice = scans ? scans.slice(0, 6) : [];

            const onScanSuccess = async (decodedText, decodedResult) => {
                console.log(`Scan result: ${decodedText}`, decodedResult);
                window.Html5QrcodeScanner.clear();
            };

            const config = {
                fps: 10,
                rememberLastUsedCamera: false,
                showTorchButtonIfSupported: true,
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            };

            return (
                <>
                    <Scanner config={config} onScanSuccess={onScanSuccess}
                        updateScans={updateScans} />
                    <section>
                        <div>  <h2>Scan History</h2>  {scansSlice.length > 0 && (
                            <button><Link to={'/barcode/scans'}>See all scans</Link></button>
                        )}</div>
                        {scansSlice.length > 0 ? (
                            scansSlice.map((scan) =>
                            (<section>

                                <ScanCard uid={scan.uid} title={scan.title} path={scan.path} image={scan.image} handleShareCard={handleShareCard} isCopied={isCopied} handleCopyText={handleCopyText} isSharing={isSharing} backBtn={false} />

                            </section>)
                            )
                        ) : (
                            <p>Scan History will appear here</p>
                        )}
                    </section>
                </>
            );
        };

        const Result = (

        ) => {

            const {
                handleShareCard, handleCopyText, isCopied, isSharing,

            } = useContext(BarcodeContext);

            const location = useLocation();
            const navigate = useNavigate();

            const { uid, image, title, path, } = location.state;

            return (
                <section
                //    className={`scan-card ${type}`}
                >
                    <ScanCard uid={uid} title={title} path={path} image={image} handleShareCard={handleShareCard} isCopied={isCopied} handleCopyText={handleCopyText} isSharing={isSharing} type='individual' />
                </section>
            );
        };

        const Scanner = ({ config,
            onScanSuccess,
            updateScans
        }) => {

            const {
                handleShareCard, handleCopyText, isCopied, isSharing,

            } = useContext(BarcodeContext);

            const [startScanning, setStartScanning] = useState(false);
            const [uid, setUid] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const navigate = useNavigate();

            useEffect(() => {
                const onScanSuccessWrapper = async (decodedText, decodedResult) => {
                    console.log(`Scan result: ${decodedText}`, decodedResult);
                    setLoading(true);
                    setError(null);
                    setUid(decodedText);

                    try {
                        const result = await fetch(`http://localhost:8000/barcode/${decodedText}`);
                        const data = await result.json();

                        if (data) {
                            const { title, image, uid, path } = data;
                            let scans = JSON.parse(localStorage.getItem('scans') || '{}');
                            // if uid already exists in scans, don't duplicate
                            if (!scans[uid]) {

                                scans[uid] = { title, image, path };

                                localStorage.setItem('scans', JSON.stringify(scans));
                                updateScans();
                            }

                            navigate(`/barcode/${uid}`, {
                                state: {
                                    title,
                                    image,
                                    uid,
                                    path,
                                }
                            });
                        } else {
                            throw new Error('Collection item not found');
                        }
                    } catch (error) {
                        setError(error.message || 'An error occurred while fetching the barcode data.');
                    } finally {
                        setLoading(false);
                    }
                };

                const html5QrcodeScanner = new window.Html5QrcodeScanner('qr-reader', config);
                html5QrcodeScanner.render(onScanSuccessWrapper);

                return () => {
                    html5QrcodeScanner.clear();
                };
            }, [config]);

            return (
                <div>
                    <div id="qr-reader"></div>
                    <div id="result"></div>
                </div>
            );
        };

        const Scans = ({ scans,
        }) => {
            const {
                handleShareCard, handleCopyText, isCopied, isSharing,
            } = useContext(BarcodeContext);
            const navigate = useNavigate();
            return (
                <section>
                    <button onClick={() => navigate(-1)}>Back</button>
                    <h2>Scan history</h2>
                    {scans &&
                        scans.map((scan) => (
                            <ScanCard uid={scan.uid} title={scan.title} path={scan.path} image={scan.image} handleShareCard={handleShareCard} isCopied={isCopied} handleCopyText={handleCopyText} isSharing={isSharing} />
                        ))}
                </section>
            );
        };

        const App = () => {

            const [scans, setScans] = useState([]);

            const handleScans = useCallback(() => {
                const storedData = localStorage.getItem('scans');
                if (storedData === null) return [];
                let scans;
                try {
                    scans = JSON.parse(storedData);
                } catch (error) {
                    console.error('Error parsing scans:', error);
                    return [];
                }

                return Object.values(scans);

            }, [])

            const fetchAllScans = useCallback(async () => {
                const newScans = await handleScans();
                setScans(newScans);
            }, [handleScans]);


            useEffect(() => {
                fetchAllScans();
            }, [fetchAllScans]);

            const updateScans = useCallback(() => {
                fetchAllScans();
            }, [fetchAllScans]);

            return (
                <BarcodeProvider>
                    <BrowserRouter>
                        <Routes>
                            <Route path="/barcode/" element={<Home
                                scans={scans}
                                updateScans={updateScans}

                            />} />
                            <Route path="/barcode/:uid" element={<Result />}
                            />
                            <Route
                                path="barcode/scans"
                                element={
                                    <Scans
                                        scans={scans}

                                    />
                                }
                            />
                        </Routes>
                    </BrowserRouter>
                </ BarcodeProvider>

            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

</body>

</html>